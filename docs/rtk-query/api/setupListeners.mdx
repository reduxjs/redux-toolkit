---
id: setupListeners
title: setupListeners
sidebar_label: setupListeners
hide_title: true
hide_table_of_contents: false
description: 'RTK Query > API: setupListeners reference'
---

&nbsp;

# `setupListeners`

A utility used to enable `refetchOnFocus` and `refetchOnReconnect` behaviors. It requires the `dispatch` method from your store. Calling `setupListeners(store.dispatch)` will configure listeners with the recommended defaults, but you have the option of providing a callback for more granular control.

```ts title="setupListeners default configuration" no-transpile
let initialized = false
export function setupListeners(
  dispatch: ThunkDispatch<any, any, any>,
  customHandler?: (
    dispatch: ThunkDispatch<any, any, any>,
    actions: {
      onFocus: typeof onFocus
      onFocusLost: typeof onFocusLost
      onOnline: typeof onOnline
      onOffline: typeof onOffline
    },
  ) => () => void,
) {
  function defaultHandler() {
    const handleFocus = () => dispatch(onFocus())
    const handleFocusLost = () => dispatch(onFocusLost())
    const handleOnline = () => dispatch(onOnline())
    const handleOffline = () => dispatch(onOffline())
    const handleVisibilityChange = () => {
      if (window.document.visibilityState === 'visible') {
        handleFocus()
      } else {
        handleFocusLost()
      }
    }

    if (!initialized) {
      if (typeof window !== 'undefined' && window.addEventListener) {
        // Handle focus events
        window.addEventListener(
          'visibilitychange',
          handleVisibilityChange,
          false,
        )
        window.addEventListener('focus', handleFocus, false)

        // Handle connection events
        window.addEventListener('online', handleOnline, false)
        window.addEventListener('offline', handleOffline, false)
        initialized = true
      }
    }
    const unsubscribe = () => {
      window.removeEventListener('focus', handleFocus)
      window.removeEventListener('visibilitychange', handleVisibilityChange)
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
      initialized = false
    }
    return unsubscribe
  }

  return customHandler
    ? customHandler(dispatch, { onFocus, onFocusLost, onOffline, onOnline })
    : defaultHandler()
}
```

If you notice, `onFocus`, `onFocusLost`, `onOffline`, `onOnline` are all actions that are provided to the callback. Additionally, these actions are made available to `api.internalActions` and are able to be used by dispatching them like this:

```ts title="Manual onFocus event" no-transpile
dispatch(api.internalActions.onFocus())
```


# `setupListeners` for `react-native`

Uses `@react-native-community/netinfo` for offline detection.


```ts title="setupListeners example for react-native" no-transpile
export function setupListenersReactNative(
  dispatch: ThunkDispatch<any, any, any>,
  customHandler?: (
    dispatch: ThunkDispatch<any, any, any>,
    actions: {
      onFocus: typeof onFocus;
      onFocusLost: typeof onFocusLost;
      onOnline: typeof onOnline;
      onOffline: typeof onOffline;
    }
  ) => () => void
) {
  function defaultHandler() {
    let unsubscribeOnChange: NativeEventSubscription | undefined;
    let unsubscribeOnNetworkStatusChange: NetInfoSubscription | undefined;

    if (!initialized) {
      // Handle focus events
      unsubscribeOnChange = AppState.addEventListener("change", (state) => {
        if (state === "active") {
          dispatch(onFocus());
        } else if (state === "background") {
          dispatch(onFocusLost());
        }
      });

      // Handle connection events
      unsubscribeOnNetworkStatusChange = NetInfo.addEventListener((state) => {
        if (state.isConnected) {
          dispatch(onOnline());
        } else {
          dispatch(onOffline());
        }
      });
      initialized = true;
    }

    const unsubscribe = () => {
      unsubscribeOnChange?.remove();
      unsubscribeOnNetworkStatusChange?.();
      initialized = false;
    };
    return unsubscribe;
  }

  return customHandler
    ? customHandler(dispatch, { onFocus, onFocusLost, onOffline, onOnline })
    : defaultHandler();
}

```
